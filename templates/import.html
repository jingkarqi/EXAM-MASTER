{% extends "base.html" %}

{% block title %}导入题库 - ExamMaster{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-upload"></i>
        导入题库
    </h1>
    <p class="page-subtitle">上传题库文件，开启个性化学习</p>
</div>

<div class="import-container">
    <div class="prompt-helper card mb-4">
        <div class="prompt-helper-header">
            <div>
                <h3 class="card-title mb-1">
                    <i class="fas fa-lightbulb"></i>
                    制作题库提醒
                </h3>
                <p class="prompt-helper-desc">还没有符合导入规范的 CSV？复制下方提示词交给任意 AI，即可按题库要求批量生成。</p>
            </div>
            <button type="button" class="btn btn-outline-primary" id="togglePromptBtn">
                <i class="fas fa-eye"></i>
                查看提示词
            </button>
        </div>
        <div class="prompt-helper-body" id="csvPromptSection" style="display: none;">
            <div class="prompt-helper-actions">
                <span class="text-muted">将提示词粘贴到成熟的 AI 产品中，上传你的私人知识库即可生成 CSV。注意修改题目制作需求中的参数。推荐使用深度思考模型，如 Deepseek 等。</span>
                <button type="button" class="btn btn-secondary" id="copyPromptBtn">
                    <i class="fas fa-copy"></i>
                    复制提示词
                </button>
            </div>
            <pre class="prompt-code-block"><code id="csvPromptBlock">{{ csv_generation_prompt | e }}</code></pre>
        </div>
    </div>
    <form id="uploadForm" method="post" enctype="multipart/form-data" action="{{ url_for('load_data.upload') }}">
        <!-- 题库选择 -->
        <div class="bank-selection card mb-4">
            <h3 class="card-title mb-3">
                <i class="fas fa-layer-group"></i> 选择目标题库
            </h3>
            <div class="bank-option">
                <label>
                    <input type="radio" name="target_mode" value="existing" checked>
                    导入到已有题库
                </label>
                <select name="existing_bank_id" id="existingBankSelect" class="form-control mt-2">
                    {% for bank in banks %}
                        <option value="{{ bank.id }}" {% if bank.id == active_bank_id %}selected{% endif %}>
                            {{ bank.name }}（{{ bank.question_count or 0 }} 题）
                        </option>
                    {% else %}
                        <option value="0" selected>{{ system_bank_name or '系统默认题库' }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="bank-option mt-3">
                <label>
                    <input type="radio" name="target_mode" value="new">
                    新建题库
                </label>
                <div id="newBankFields" class="new-bank-fields">
                    <div class="form-group">
                        <label class="form-label">题库名称</label>
                        <input type="text" name="new_bank_name" class="form-control" placeholder="例如：2025 年毛概题库">
                    </div>
                    <div class="form-group">
                        <label class="form-label">描述（可选）</label>
                        <textarea name="new_bank_description" class="form-control" rows="2" placeholder="一句话介绍题库来源或用途"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传区域 -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3 class="upload-title">拖放文件到此处</h3>
            <p class="upload-subtitle">或点击选择文件</p>
            <input type="file" id="fileInput" name="file" accept=".csv,.txt" hidden>
            <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-folder-open"></i>
                选择文件
            </button>
        </div>

        <!-- 文件信息 -->
        <div class="file-info" id="fileInfo" style="display: none;">
            <div class="file-info-header">
                <i class="fas fa-file-alt"></i>
                <span id="fileName"></span>
            </div>
            <div class="file-info-details">
                <div class="file-info-item">
                    <span class="file-info-label">文件大小：</span>
                    <span id="fileSize"></span>
                </div>
                <div class="file-info-item">
                    <span class="file-info-label">文件类型：</span>
                    <span id="fileType"></span>
                </div>
            </div>
            <div class="file-actions">
                <button type="button" class="btn btn-secondary" onclick="clearFile()">
                    <i class="fas fa-times"></i>
                    取消选择
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i>
                    开始上传
                </button>
            </div>
        </div>

        <input type="file" name="file" id="formFileInput" accept=".csv,.txt" hidden>
    </form>

    <!-- 格式说明 -->
    <div class="format-info">
        <h4 class="format-title">
            <i class="fas fa-info-circle"></i>
            支持的文件格式
        </h4>
        <div class="format-cards">
            <div class="format-card">
                <div class="format-card-header">
                    <i class="fas fa-file-csv"></i>
                    <h5>CSV 格式</h5>
                </div>
                <div class="format-card-body">
                    <p>标准 CSV 格式，包含以下字段：</p>
                    <ul>
                        <li><strong>题号</strong> - 题目唯一标识</li>
                        <li><strong>题干</strong> - 题目内容</li>
                        <li><strong>A, B, C, D, E</strong> - 选项内容</li>
                        <li><strong>答案</strong>
                            <br>- 选择题答案如 A, AB, C
                            <br>- 填空题多空答案使用英文括号 <code>()</code>，如 <code>(答案1)(答案2)</code>
                            <br>- 判断题答案为 <code>正确</code> 或 <code>错误</code>
                        </li>
                        <li><strong>难度</strong> - 题目难度</li>
                        <li><strong>题型</strong> - 单选题/多选题/判断题/填空题</li>
                        <li><strong>类别</strong> - 题目分类</li>
                    </ul>
                </div>
            </div>
            <div class="format-card">
                <div class="format-card-header">
                    <i class="fas fa-file-alt"></i>
                    <h5>TXT 格式</h5>
                </div>
                <div class="format-card-body">
                    <p>支持以下格式的文本文件：</p>
                    <ul>
                        <li>题干内容</li>
                        <li>A 选项内容</li>
                        <li>B 选项内容</li>
                        <li>...</li>
                        <li>\ans:正确答案</li>
                    </ul>
                    <p class="text-muted">或</p>
                    <ul>
                        <li>1. 题干内容</li>
                        <li>A. 选项内容</li>
                        <li>B. 选项内容</li>
                        <li>...</li>
                        <li>【答案】正确答案</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 注意事项 -->
<div class="notice-box">
        <div class="notice-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>注意事项</h4>
        </div>
        <div class="notice-content">
            <ul>
                <li>文件大小不能超过 10MB</li>
                <li>仅支持 UTF-8 编码的文件</li>
                <li>上传前请确保文件格式正确</li>
                <li>系统会自动验证题目数据的有效性</li>
                <li>重复的题号将被跳过</li>
            </ul>
        </div>
    </div>
</div>

<style>
    .bank-selection .bank-option label {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--gray-800);
    }

    .bank-option select {
        max-width: 400px;
    }

    .new-bank-fields {
        display: none;
        margin-top: 0.75rem;
        padding-left: 1.5rem;
        border-left: 2px dashed var(--gray-200);
    }

    .bank-selection .form-group {
        margin-bottom: 0.75rem;
    }

    .prompt-helper {
        border: 1px solid var(--gray-200, #e5e7eb);
        border-left: 4px solid var(--primary-color, #4c6ef5);
        border-radius: 0.75rem;
        padding: 1.25rem;
        background: #fff;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
    }

    .prompt-helper-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .prompt-helper-desc {
        margin: 0;
        color: var(--gray-600, #6b7280);
        font-size: 0.95rem;
    }

    .prompt-helper-body {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dashed var(--gray-200, #e5e7eb);
    }

    .prompt-helper-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
    }

    .prompt-code-block {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        max-height: 340px;
        overflow: auto;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
</style>

<!-- 加载遮罩 -->
<div class="loading-mask" id="loadingMask" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>正在处理文件，请稍候...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='load_data.js') }}"></script>
<script>
// 文件选择处理
document.getElementById('fileInput').addEventListener('change', handleFileSelect);
document.getElementById('formFileInput').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        console.log('文件选择事件:', event.target.id, file.name);
        displayFileInfo(file);

        // 确保表单文件输入始终有文件
        const formFileInput = document.getElementById('formFileInput');
        const dt = new DataTransfer();
        dt.items.add(file);
        formFileInput.files = dt.files;
        console.log('同步文件到 formFileInput:', formFileInput.files.length, '个文件');
    }
}

function displayFileInfo(file) {
    const uploadArea = document.getElementById('uploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');

    // 更新文件信息
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileType.textContent = getFileType(file.name);

    // 显示文件信息，隐藏上传区域
    uploadArea.style.display = 'none';
    fileInfo.style.display = 'block';
}

function clearFile() {
    // 清空文件输入
    document.getElementById('fileInput').value = '';
    document.getElementById('formFileInput').value = '';

    // 显示上传区域，隐藏文件信息
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (ext === 'csv') return 'CSV 文件';
    if (ext === 'txt') return '文本文件';
    return '未知文件';
}

// 拖放功能
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (allowedFile(file.name)) {
            // 使用 DataTransfer 来设置文件输入
            const dt = new DataTransfer();
            dt.items.add(file);

            // 确保两个文件输入都有文件
            document.getElementById('fileInput').files = dt.files;
            document.getElementById('formFileInput').files = dt.files;

            console.log('拖放文件同步完成:', file.name);
            displayFileInfo(file);
        } else {
            alert('只支持 CSV 和 TXT 格式的文件');
        }
    }
});

function allowedFile(filename) {
    const allowedExtensions = ['csv', 'txt'];
    const ext = filename.split('.').pop().toLowerCase();
    return allowedExtensions.includes(ext);
}

// 表单提交处理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const formFileInput = document.getElementById('formFileInput');

    // 检查表单文件输入是否有文件
    if (!formFileInput || !formFileInput.files || formFileInput.files.length === 0) {
        e.preventDefault();
        alert('请先选择要上传的文件');
        return;
    }

    // 显示加载遮罩
    document.getElementById('loadingMask').style.display = 'flex';

    console.log('提交表单，文件:', formFileInput.files[0].name);
});

// 提示词展开/复制功能
const promptToggleBtn = document.getElementById('togglePromptBtn');
const promptSection = document.getElementById('csvPromptSection');
const promptBlock = document.getElementById('csvPromptBlock');
const copyPromptBtn = document.getElementById('copyPromptBtn');

function updatePromptToggleButton(isOpen) {
    if (!promptToggleBtn) return;
    promptToggleBtn.innerHTML = isOpen
        ? '<i class="fas fa-eye-slash"></i> 收起提示词'
        : '<i class="fas fa-eye"></i> 查看提示词';
}

if (promptToggleBtn && promptSection) {
    updatePromptToggleButton(false);
    promptToggleBtn.addEventListener('click', () => {
        const isHidden = promptSection.style.display === 'none' || promptSection.style.display === '';
        promptSection.style.display = isHidden ? 'block' : 'none';
        updatePromptToggleButton(isHidden);
    });
}

if (copyPromptBtn && promptBlock) {
    copyPromptBtn.addEventListener('click', () => {
        const promptText = promptBlock.textContent;
        copyPromptToClipboard(promptText).then(() => {
            copyPromptBtn.innerHTML = '<i class="fas fa-check"></i> 已复制';
            copyPromptBtn.classList.remove('btn-secondary');
            copyPromptBtn.classList.add('btn-success');
            setTimeout(() => {
                copyPromptBtn.innerHTML = '<i class="fas fa-copy"></i> 复制提示词';
                copyPromptBtn.classList.remove('btn-success');
                copyPromptBtn.classList.add('btn-secondary');
            }, 1600);
        }).catch(() => {
            alert('复制失败，请手动选择并复制提示词内容');
        });
    });
}

function copyPromptToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text);
    }
    return new Promise((resolve, reject) => {
        try {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            const result = document.execCommand('copy');
            document.body.removeChild(textarea);
            if (result) {
                resolve();
            } else {
                reject(new Error('execCommand failed'));
            }
        } catch (err) {
            reject(err);
        }
    });
}
</script>
{% endblock %}
