{% extends "base.html" %}

{% block title %}导入题库 - ExamMaster{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-upload"></i>
        导入题库
    </h1>
    <p class="page-subtitle">上传题库文件，开启个性化学习</p>
</div>

<div class="import-container">
    <!-- 上传区域 -->
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h3 class="upload-title">拖放文件到此处</h3>
        <p class="upload-subtitle">或点击选择文件</p>
        <input type="file" id="fileInput" name="file" accept=".csv,.txt" hidden>
        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-folder-open"></i>
            选择文件
        </button>
    </div>

    <!-- 文件信息 -->
    <div class="file-info" id="fileInfo" style="display: none;">
        <div class="file-info-header">
            <i class="fas fa-file-alt"></i>
            <span id="fileName"></span>
        </div>
        <div class="file-info-details">
            <div class="file-info-item">
                <span class="file-info-label">文件大小：</span>
                <span id="fileSize"></span>
            </div>
            <div class="file-info-item">
                <span class="file-info-label">文件类型：</span>
                <span id="fileType"></span>
            </div>
        </div>
        <div class="file-actions">
            <button type="button" class="btn btn-secondary" onclick="clearFile()">
                <i class="fas fa-times"></i>
                取消选择
            </button>
            <button type="submit" class="btn btn-primary" form="uploadForm">
                <i class="fas fa-upload"></i>
                开始上传
            </button>
        </div>
    </div>

    <!-- 上传表单 -->
    <form id="uploadForm" method="post" enctype="multipart/form-data" action="{{ url_for('load_data.upload') }}">
        <input type="file" name="file" id="formFileInput" accept=".csv,.txt" hidden>
    </form>

    <!-- 格式说明 -->
    <div class="format-info">
        <h4 class="format-title">
            <i class="fas fa-info-circle"></i>
            支持的文件格式
        </h4>
        <div class="format-cards">
            <div class="format-card">
                <div class="format-card-header">
                    <i class="fas fa-file-csv"></i>
                    <h5>CSV 格式</h5>
                </div>
                <div class="format-card-body">
                    <p>标准 CSV 格式，包含以下字段：</p>
                    <ul>
                        <li><strong>题号</strong> - 题目唯一标识</li>
                        <li><strong>题干</strong> - 题目内容</li>
                        <li><strong>A, B, C, D, E</strong> - 选项内容</li>
                        <li><strong>答案</strong> - 正确答案（如 A, AB, C）</li>
                        <li><strong>难度</strong> - 题目难度</li>
                        <li><strong>题型</strong> - 单选题/多选题/判断题/填空题</li>
                        <li><strong>类别</strong> - 题目分类</li>
                    </ul>
                </div>
            </div>
            <div class="format-card">
                <div class="format-card-header">
                    <i class="fas fa-file-alt"></i>
                    <h5>TXT 格式</h5>
                </div>
                <div class="format-card-body">
                    <p>支持以下格式的文本文件：</p>
                    <ul>
                        <li>题干内容</li>
                        <li>A 选项内容</li>
                        <li>B 选项内容</li>
                        <li>...</li>
                        <li>\ans:正确答案</li>
                    </ul>
                    <p class="text-muted">或</p>
                    <ul>
                        <li>1. 题干内容</li>
                        <li>A. 选项内容</li>
                        <li>B. 选项内容</li>
                        <li>...</li>
                        <li>【答案】正确答案</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 注意事项 -->
    <div class="notice-box">
        <div class="notice-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>注意事项</h4>
        </div>
        <div class="notice-content">
            <ul>
                <li>文件大小不能超过 10MB</li>
                <li>仅支持 UTF-8 编码的文件</li>
                <li>上传前请确保文件格式正确</li>
                <li>系统会自动验证题目数据的有效性</li>
                <li>重复的题号将被跳过</li>
            </ul>
        </div>
    </div>
</div>

<!-- 加载遮罩 -->
<div class="loading-mask" id="loadingMask" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>正在处理文件，请稍候...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='load_data.js') }}"></script>
<script>
// 文件选择处理
document.getElementById('fileInput').addEventListener('change', handleFileSelect);
document.getElementById('formFileInput').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        console.log('文件选择事件:', event.target.id, file.name);
        displayFileInfo(file);

        // 确保表单文件输入始终有文件
        const formFileInput = document.getElementById('formFileInput');
        const dt = new DataTransfer();
        dt.items.add(file);
        formFileInput.files = dt.files;
        console.log('同步文件到 formFileInput:', formFileInput.files.length, '个文件');
    }
}

function displayFileInfo(file) {
    const uploadArea = document.getElementById('uploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');

    // 更新文件信息
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileType.textContent = getFileType(file.name);

    // 显示文件信息，隐藏上传区域
    uploadArea.style.display = 'none';
    fileInfo.style.display = 'block';
}

function clearFile() {
    // 清空文件输入
    document.getElementById('fileInput').value = '';
    document.getElementById('formFileInput').value = '';

    // 显示上传区域，隐藏文件信息
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (ext === 'csv') return 'CSV 文件';
    if (ext === 'txt') return '文本文件';
    return '未知文件';
}

// 拖放功能
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (allowedFile(file.name)) {
            // 使用 DataTransfer 来设置文件输入
            const dt = new DataTransfer();
            dt.items.add(file);

            // 确保两个文件输入都有文件
            document.getElementById('fileInput').files = dt.files;
            document.getElementById('formFileInput').files = dt.files;

            console.log('拖放文件同步完成:', file.name);
            displayFileInfo(file);
        } else {
            alert('只支持 CSV 和 TXT 格式的文件');
        }
    }
});

function allowedFile(filename) {
    const allowedExtensions = ['csv', 'txt'];
    const ext = filename.split('.').pop().toLowerCase();
    return allowedExtensions.includes(ext);
}

// 表单提交处理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const formFileInput = document.getElementById('formFileInput');

    // 检查表单文件输入是否有文件
    if (!formFileInput || !formFileInput.files || formFileInput.files.length === 0) {
        e.preventDefault();
        alert('请先选择要上传的文件');
        return;
    }

    // 显示加载遮罩
    document.getElementById('loadingMask').style.display = 'flex';

    console.log('提交表单，文件:', formFileInput.files[0].name);
});
</script>
{% endblock %}